worker_processes auto;

events{}

http {
    # Configure buffer sizes
    client_body_buffer_size 16k;
    client_header_buffer_size 1k;
    client_max_body_size 8m;
    large_client_header_buffers 2 8k;

    # Configure timeouts
    client_body_timeout 12;
    client_header_timeout 12;

    server {
        listen 80;

        # ---------- CORS ----------
        add_header "Access-Control-Allow-Origin" "http://localhost:5173" always;
        add_header "Access-Control-Allow-Credentials" "true" always;
        add_header "Access-Control-Allow-Headers" "Authorization,Content-Type" always;
        add_header "Access-Control-Allow-Methods" "GET,POST,PUT,DELETE,OPTIONS" always;

        # Handle OPTIONS preflight globally
        if ($request_method = OPTIONS) {
            return 204;
        }

        # ---------- PUBLIC ----------
        location /auth/login {
            proxy_pass http://auth-fastapi-container:80/auth/login;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /auth/register {
            proxy_pass http://auth-fastapi-container:80/auth/register;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /auth/google/ {
            proxy_pass http://auth-fastapi-container:80/auth/google/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------- REFRESH ----------
        location /token/refresh {
            proxy_pass http://auth-fastapi-container:80/token/refresh;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # ---------- INTERNAL AUTH CHECK ----------
        location = /_auth_check {
            internal;
            proxy_pass http://auth-fastapi-container:80/token/check;
            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
            proxy_set_header Authorization $http_authorization;
        }

        # ---------- PROTECTED ----------
        location /users/ {
            auth_request /_auth_check;
            proxy_pass http://auth-fastapi-container:80/users/;
        }
        location /roles/ {
            auth_request /_auth_check;
            proxy_pass http://auth-fastapi-container:80/roles/;
        }
        location /auth/logout {
            proxy_pass http://auth-fastapi-container:80/auth/logout;
        }
        location /modifications/ {
            auth_request /_auth_check;
            proxy_pass http://auth-fastapi-container:80/modifications/;
        }
        location /activity/ {
            auth_request /_auth_check;
            proxy_pass http://auth-fastapi-container:80/activity/;
        }
    }
}